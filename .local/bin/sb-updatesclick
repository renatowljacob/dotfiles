#!/bin/sh

# 1 = left click

print_packages()
{
    lines="$(wc -l "${cachefile}")"
    packages=

    # Truncate if there are more than 27 packages listed
    [ "${lines%% *}" -gt 27 ] \
        && packages="$(printf '%b' "$(sed -n '1,26p' "${cachefile}")\n...")"

    printf '%b' "${packages:-$(cat "${cachefile}")}"
}

case $BLOCK_BUTTON in
1)
    cachefile=${XDG_RUNTIME_DIR:-/tmp}/"dusk-updatesclick"

    if updates="$(checkupdates -c --nocolor)" || [ ! -e "${cachefile}" ]; then
        [ -n "${updates}" ] \
            && printf '%s' "${updates:-$(checkupdates --nocolor)}" \
            | sed 's/\([[:alnum:]]*\) .*/\1/' > "${cachefile}"

        dunstify -a "Updates" "$(print_packages)"
    else
        : > "${cachefile}" && dunstify -a "Updates" "No updates available"
    fi

    duskc --ignore-reply run_command setstatus 4 "$(sb-updates)" &
    ;;
esac
